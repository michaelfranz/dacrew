# yaml-language-server: $schema=https://raw.githubusercontent.com/microsoft/vscode/main/extensions/github-actions/schemas/github-workflow.json

name: Python Tests

on:
  push:
    branches:
      - main
      - 'feature/*'
      - 'bugfix/*'
      - 'hotfix/*'
  pull_request:
    branches:
      - main
      - 'feature/*'

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 8

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          tags: jira-ai-test:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Run tests in Docker
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            -w /app \
            jira-ai-test:latest \
            pytest tests/unit/ \
              --timeout=30 \
              --timeout-method=thread \
              --numprocesses=auto \
              --junitxml=test-results.xml \
              --cov=src \
              --cov-report=xml:coverage.xml \
              --cov-report=term-missing \
              --tb=short \
              --maxfail=5 \
              -v

      - name: Run integration tests (if they exist)
        continue-on-error: true
        run: |
          if [ -d "tests/integration" ] && find tests/integration -name "test_*.py" | head -1 | grep -q .; then
            echo "Running integration tests..."
            docker run --rm \
              -v ${{ github.workspace }}:/app \
              -w /app \
              jira-ai-test:latest \
              pytest tests/integration/ \
                --timeout=60 \
                --timeout-method=thread \
                --junitxml=test-results-integration.xml \
                --cov=src \
                --cov-append \
                --cov-report=xml:coverage-integration.xml \
                --tb=short \
                --maxfail=3 \
                -v
          else
            echo "No integration tests found, skipping..."
          fi

      - name: Show test summary
        if: always()
        run: |
          echo "## 🧪 Test Results Summary" >> $GITHUB_STEP_SUMMARY
          
          if [ -f test-results.xml ]; then
            TESTS_COUNT=$(grep -o 'tests="[^"]*"' test-results.xml | head -1 | cut -d'"' -f2 2>/dev/null || echo "unknown")
            FAILURES_COUNT=$(grep -o 'failures="[^"]*"' test-results.xml | head -1 | cut -d'"' -f2 2>/dev/null || echo "unknown")
            ERRORS_COUNT=$(grep -o 'errors="[^"]*"' test-results.xml | head -1 | cut -d'"' -f2 2>/dev/null || echo "unknown")
          
            echo "- ✅ **Tests Run:** $TESTS_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- ❌ **Failures:** $FAILURES_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- 🚨 **Errors:** $ERRORS_COUNT" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ⚠️ No test results found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results*.xml
            coverage*.xml
          retention-days: 7